name: Build Godot Project

on:
  pull_request:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            godot_executable: "Godot_v4.2.1-stable_linux.x86_64"
            godot_url: https://github.com/godotengine/godot/releases/download/4.2.1-stable/Godot_v4.2.1-stable_linux.x86_64.zip
            platform: "Linux/X11"
            extension: "x86_64"
            use_xvfb: true
          - os: macos-latest
            godot_executable: "Godot_v4.2.1-stable_macos.universal"
            godot_url: https://github.com/godotengine/godot/releases/download/4.2.1-stable/Godot_v4.2.1-stable_macos.universal.zip
            platform: "Mac OS X"
            extension: "dmg"
          - os: windows-latest
            godot_executable: "Godot_v4.2.1-stable_win64.exe"
            godot_url: https://github.com/godotengine/godot/releases/download/4.2.1-stable/Godot_v4.2.1-stable_win64.exe.zip
            platform: "Windows Desktop"
            extension: "exe"

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Download and Extract Godot
      run: |
        wget ${{ matrix.godot_url }}
        unzip *.zip
        
    - name: Setup Xvfb
      if: matrix.use_xvfb
      run: |
        sudo apt-get update -y
        sudo apt-get install -y xvfb
        Xvfb :99 & 
        export DISPLAY=:99

    - name: Export Project
      run: |
        if [ "${{ matrix.os }}" != "windows-latest" ]; then
          chmod +x ./${{ matrix.godot_executable }}
        fi
        ls
        ./${{ matrix.godot_executable }} --export-release "${{ matrix.platform }}" drivehcain_launcher.${{ matrix.extension }} --video-driver GLES2

    - name: Upload Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: drivechain_launcher-${{ matrix.platform }}
        path: drivechain_launcher.${{ matrix.extension }}
